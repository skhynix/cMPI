# Caption

## Setup
### Prerequisite
- Must
    - Python 3
    - Linux Kernel with N:M interleaving [patch](https://lore.kernel.org/linux-mm/YqD0%2FtzFwXvJ1gK6@cmpxchg.org/T/)
      + The patch added a tunable parameter (numa\_tier\_interleave) in `vm_table` in `kernel/sysctl.c`
      + In our case, we use two parameters to control the top and bot ratio independently.
        * `numa_tier_interleave_top` for top tier
        * `numa_tier_interleave_bot` for bot tier
      + The rest of the patch is applied without any modification
    - Intel PCM
      + Please follow [intel-pcm](https://github.com/intel/pcm) to clone and build PCM.
      + Please update the `PCM_PATH` in `metrics/pcm_mon.py` to your pcm binary path.

### Clone
```bash
$ git clone https://github.com/ece-fast-lab/cxl_type3_tests.git 
$ cd caption_ae 
```

## Notes
* The interleaving ratio is applied to `libnuma`, `numactl --interleave` calls for memory interleaving **allocations**. Therefore, the ratio is only applied upon new memory allocations. This is orthogonal to works on memory migration.
* Currently, `Caption` assumes major memory allocation happens when the application launches, and thus, the tuning happesns at the end of each iteration of an application and before its next launch.
* Caption is independent of application output and only monitors system performance counters. However, in some cases, it may be desirable to have application output as a feed back on the direction of tunning. We leave the enhancement of the monitoring scheme as a future work. 
* Although `IPC` alone may seems sufficient, `L1 latency` and `DDR latency` are here to assit the model to identify subtle change in application's performance.

## Known issues 
* If the tunning time interval is too small, `Caption` may not be able to capture enough information about the system state.
* If the tuning stepping is too small, `Caption` may not be able to correctly indentify if the direction is correct -- i.e. the performance difference is too subtle. 

## Arguments
| Argument | Brief description | Default | Valid inputs | Note |
| -------- | ----------------- | ------- | ------------ | ---- |
| h | Help message generated by `argparser` | - | - | - |
| x | Stepping mode | - | - | Test the Caption model by simply iterating through the interleaving ratio. By default, this will iterate from DDR:CXL = 10:1 and increase the CXL ratio by 2, i.e. 10:3, 10:5 ...|
| n | No tune | - | - | This is used for monitoring the model output at a fixed interleaving ratio. The tuning algorithm is not applied in this case.|
| s | Test synchronous mode, shell script path | - | String, path to a shell script | The script may contain multiple program, where each program may execute in the background with '&'. In this case, tuning happen when the shell script exits. We provide an example script in the `example_input` folder.|
| t | Test asynchronous mode, txt file path | - | String, path to a txt file | The txt may contain muliple shell scripts. Each script will be executed by the python program in a seperate thread. In this case, tunning happen if one of the shell script exits. You may change the tuning mask (`tune_mask` in `caption.py`) to enable tunning for the ending on a specific thread (script). We provide an example txt in the `example_input`.|

## Example usage
### Syncrhnous mode
```
$ python3 caption.py -s example_input/sync_tune.sh
```

### Asynchronous mode
```
$ python3 caption.py -t example_input/async_tune.sh
```
